### Local bashrc file containing system-specific settings

## Prompt
if ! type -p starship &>/dev/null; then
  # git status in prompt
  test -e "${HOME}/.scripts/git-prompt.sh" && source "${HOME}/.scripts/git-prompt.sh"
  export GIT_PS1_SHOWDIRTYSTATE="" # chipyard is slow with this
  RESTORE='\[\e[0m\]'
  export PS1="\[\e[0;44;30m\][\w]${RESTORE}\[\e[33m\]\$(__git_ps1 \"[\[\e[03m\]%s\[\e[23m\]]\")${RESTORE}\[\e[1;38;5;4m\] â¨• ${RESTORE}"
fi

## Environment
## Conda
# The base env bin is added to PATH and will always be implicitly activated
# To activate/deactivate other environment, run the following commands
# Activate environment:   conda activate <env>
# Deactivate environment: cond deactivate
CONDA_HOME=${HOME}/.conda
# This is effectively `conda init`
[[ -e "${CONDA_HOME}" ]] && . "${CONDA_HOME}/etc/profile.d/conda.sh"
[[ ":$PATH:" =~ ":${CONDA_HOME}/bin:" ]] || PATH="${CONDA_HOME}/bin:$PATH"
[[ ":$MANPATH:" =~ ":${CONDA_HOME}/share/man:" ]] || MANPATH=":${CONDA_HOME}/share/man${MANPATH:+${MANPATH}}"
## Coursier
[[ ":$PATH:" =~ ":${HOME}/.local/share/coursier/bin:" ]] || PATH="${HOME}/.local/share/coursier/bin:$PATH"

export INFOPATH="${CONDA_HOME}/share/info"
export PATH MANPATH

## Refresh SSH Sock
# Terminal multiplexers like tmux/zellij won't update environment variables once they are started (even new tabs would just inherit the old environment)
# Set SSH_AUTH_SOCK to a static sock, which is a symlink to the actual forwarded sock, then relink it to the newly forwarded sock upon login
# (I think we could even put this in .bash_profile since it just needs to be run one time at the login)
if [ "${TERM}" != 'dumb' ]; then
    if [ -S ${SSH_AUTH_SOCK} ] && [ -w "/run/user/$(id -u)/" ] && ! [ -S "/run/user/$( id -u )/ssh_auth.sock" ]; then
        ln -sf "${SSH_AUTH_SOCK}" "/run/user/$(id -u)/ssh_auth.sock"
    fi
fi
# Upon login, SSH_AUTH_SOCK is set to the forwarded sock, change it to the static sock
if [ -S "/run/user/$(id -u)/ssh_auth.sock" ]; then
    export SSH_AUTH_SOCK="/run/user/$(id -u)/ssh_auth.sock"
fi

## Completion
# zellij doesn't automatically source /etc/profile in new panes
# so manually source the system-wide completion scripts
for i in /etc/profile.d/*.sh /etc/profile.d/sh.local ; do
    if [ -r "$i" ]; then
        if [ "${-#*i}" != "$-" ]; then
            . "$i"
        else
            . "$i" >/dev/null
        fi
    fi
done

if [[ -r "${CONDA_HOME}/etc/profile.d/bash_completion.sh" ]]; then
    source "${CONDA_HOME}/etc/profile.d/bash_completion.sh"
else
    for COMPLETION in "${CONDA_HOME}/etc/bash_completion.d/"*; do
        [[ -r "${COMPLETION}" ]] && source "${COMPLETION}"
    done
fi

## Ad-hoc
if [[ -z "$DISPLAY" ]]; then
    # VNC session
    export DISPLAY=:1
fi
